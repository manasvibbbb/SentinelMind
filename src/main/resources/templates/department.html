<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Department Monitor ‚Äì SentinelMind</title>

    <!-- Global CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <!-- WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>

<body>

<!-- NAVBAR -->
<div th:replace="fragments/navbar :: body"></div>

<div class="container">

    <!-- HEADER -->
    <div class="card header-card">
        <h1>üè• Emergency Room ‚Äî Live Monitor</h1>
        <p class="description">
            Real-time operational intelligence for doctors.
            High-risk workflow anomalies trigger immediate alerts
            with AI-generated explanations and recommendations.
        </p>
    </div>

    <!-- LIVE TOAST -->
    <div id="toast">
        üö® <strong>HIGH RISK ALERT</strong><br>
        Immediate clinical attention required.
        <br><br>
        <button class="btn btn-primary" onclick="ackToast()">Acknowledge</button>
    </div>

    <!-- ALERT STREAM -->
    <div id="alerts">

        <div th:each="alert : ${alerts}"
             th:class="'card alert-card ' + ${alert.riskLevel}">

            <div class="risk" th:text="${alert.riskLevel} + ' RISK'"></div>

            <p th:text="${alert.message}"></p>

            <p class="recommendation">
                <strong>Recommendation:</strong>
                <span th:text="${alert.recommendation}"></span>
            </p>

            <button class="btn btn-primary">Acknowledge</button>
        </div>

    </div>

</div>

<!-- ALERT SOUND -->
<audio id="alertSound" src="/sounds/alert.mp3" preload="auto"></audio>

<script>
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, () => {
        stompClient.subscribe('/topic/alerts', (msg) => {
            const alert = JSON.parse(msg.body);

            if (alert.riskLevel === "HIGH") {
                showToast();
                playSound();
                addAlertCard(alert);
            }
        });
    });

    function showToast() {
        const toast = document.getElementById("toast");
        toast.style.display = "block";
    }

    function ackToast() {
        document.getElementById("toast").style.display = "none";
    }

    function playSound() {
        const audio = document.getElementById("alertSound");
        audio.currentTime = 0;
        audio.play();
    }

    function addAlertCard(alert) {
        const container = document.getElementById("alerts");

        const card = document.createElement("div");
        card.className = "card alert-card HIGH";

        card.innerHTML = `
            <div class="risk">HIGH RISK</div>
            <p>${alert.message}</p>
            <p class="recommendation">
                <strong>Recommendation:</strong> ${alert.recommendation}
            </p>
            <button class="btn btn-primary">Acknowledge</button>
        `;

        container.prepend(card);
    }
</script>

</body>
</html>
